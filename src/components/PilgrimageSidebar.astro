---
/**
 * ================================================================================
 * PILGRIMAGE SIDEBAR — Sticky affiliate sidebar for monetized pages
 * ================================================================================
 * Used on Place pages and Route pages ONLY.
 * Hub, Story, and Context pages are monetization-forbidden.
 * ================================================================================
 */

interface SidebarProduct {
    title: string;
    url: string;
    image?: string;
    tier: 'hero' | 'value' | 'premium';
    price?: string;
    rating?: number;
    reviews?: number;
    label?: string;
    duration?: string;
}

interface Props {
    products: SidebarProduct[];
    heading?: string;
    productCount?: number;
}

const { products, heading = 'Plan Your Visit', productCount } = Astro.props;
const heroProduct = products.find(p => p.tier === 'hero');
const valueProduct = products.find(p => p.tier === 'value');
const premiumProduct = products.find(p => p.tier === 'premium');
const displayCount = productCount ?? products.length;

const tierConfig = {
    hero:    { badge: 'Top Pick',  badgeColor: 'text-amber-400' },
    value:   { badge: 'Best Value', badgeColor: 'text-emerald-400' },
    premium: { badge: 'Premium',   badgeColor: 'text-accent' },
};
---

<aside class="hidden lg:block lg:w-1/3">
    <div class="sticky top-8 space-y-4">
        <h3 class="text-lg font-bold text-white mb-2">{heading}</h3>

        {/* ---- HERO PRODUCT (image card) ---- */}
        {heroProduct && (
            <a href={heroProduct.url} target="_blank"
                rel="noopener noreferrer nofollow"
                class="group block rounded-lg overflow-hidden bg-white/5 border border-white/10 hover:border-primary/50 transition-all duration-300 no-underline">
                {heroProduct.image && (
                    <div class="aspect-video overflow-hidden">
                        <img src={heroProduct.image} alt={heroProduct.title}
                            class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300"
                            width="720" height="480" loading="lazy" decoding="async" />
                    </div>
                )}
                <div class="p-4">
                    <span class={`text-xs font-medium uppercase tracking-wider ${tierConfig.hero.badgeColor}`}>
                        {heroProduct.label ?? tierConfig.hero.badge}
                    </span>
                    <h4 class="text-white font-semibold group-hover:text-primary transition-colors mt-1 mb-2 text-sm leading-snug">
                        {heroProduct.title}
                    </h4>
                    <div class="flex items-center gap-2 text-xs text-gray-400 mb-3">
                        {heroProduct.rating && <span class="text-yellow-400">★ {heroProduct.rating}</span>}
                        {heroProduct.reviews && <span>({heroProduct.reviews.toLocaleString()})</span>}
                        {heroProduct.duration && <span>· {heroProduct.duration}</span>}
                    </div>
                    <div class="flex items-center justify-between">
                        {heroProduct.price && <span class="text-lg font-bold text-white">From {heroProduct.price}</span>}
                        <span class="px-3 py-1.5 rounded-lg bg-primary text-primary-content text-xs font-semibold group-hover:bg-primary/85 transition-colors">
                            View Details →
                        </span>
                    </div>
                </div>
            </a>
        )}

        {/* ---- VALUE PRODUCT (compact card) ---- */}
        {valueProduct && (
            <a href={valueProduct.url} target="_blank"
                rel="noopener noreferrer nofollow"
                class="group block rounded-lg p-4 bg-white/5 border border-white/10 hover:border-primary/50 transition-all duration-300 no-underline">
                <span class={`text-xs font-medium uppercase tracking-wider ${tierConfig.value.badgeColor}`}>
                    {valueProduct.label ?? tierConfig.value.badge}
                </span>
                <h4 class="text-white font-semibold group-hover:text-primary transition-colors mt-1 mb-2 text-sm leading-snug">
                    {valueProduct.title}
                </h4>
                <div class="flex items-center justify-between">
                    <div class="text-xs text-gray-400">
                        {valueProduct.rating && <span class="text-yellow-400">★ {valueProduct.rating}</span>}
                        {valueProduct.reviews && <span> ({valueProduct.reviews.toLocaleString()})</span>}
                    </div>
                    {valueProduct.price && <span class="text-white font-bold">From {valueProduct.price}</span>}
                </div>
            </a>
        )}

        {/* ---- PREMIUM PRODUCT (compact card) ---- */}
        {premiumProduct && (
            <a href={premiumProduct.url} target="_blank"
                rel="noopener noreferrer nofollow"
                class="group block rounded-lg p-4 bg-white/5 border border-white/10 hover:border-primary/50 transition-all duration-300 no-underline">
                <span class={`text-xs font-medium uppercase tracking-wider ${tierConfig.premium.badgeColor}`}>
                    {premiumProduct.label ?? tierConfig.premium.badge}
                </span>
                <h4 class="text-white font-semibold group-hover:text-primary transition-colors mt-1 mb-2 text-sm leading-snug">
                    {premiumProduct.title}
                </h4>
                <div class="flex items-center justify-between">
                    <div class="text-xs text-gray-400">
                        {premiumProduct.rating && <span class="text-yellow-400">★ {premiumProduct.rating}</span>}
                        {premiumProduct.reviews && <span> ({premiumProduct.reviews.toLocaleString()})</span>}
                    </div>
                    {premiumProduct.price && <span class="text-white font-bold">From {premiumProduct.price}</span>}
                </div>
            </a>
        )}

        <p class="text-center text-sm text-gray-500 py-2">
            {displayCount} options available
        </p>
    </div>
</aside>
