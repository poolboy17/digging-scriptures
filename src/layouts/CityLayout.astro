---
/**
 * ================================================================================
 * CITY HUB PAGE TEMPLATE
 * ================================================================================
 * Purpose: Geographic hub pages for the city silo
 * Parallel to the tradition-based HubLayout but organized by location
 * 
 * Uses shared components: HubHero, SpokeCard, SiblingNav
 * 
 * MONETIZATION: YES — Viator affiliate products in "Experiences" section
 * ================================================================================
 */

import BaseLayout from './BaseLayout.astro';
import HubHero from '../components/HubHero.astro';
import SpokeCard from '../components/SpokeCard.astro';
import SiblingNav from '../components/SiblingNav.astro';
import SpokeSidebar from '../components/SpokeSidebar.astro';
import SpokeMobileToc from '../components/SpokeMobileToc.astro';
import '@fontsource-variable/playfair-display/wght.css';
import { getCollection } from 'astro:content';

interface Props {
    title: string;
    description: string;
    tagline?: string;
    region?: string;
    country?: string;
    faithTraditions?: string[];
    spokes?: string[];
    image?: string;
    imageAlt?: string;
    imageCredit?: string;
}

const { title, description, tagline, region, country, faithTraditions, spokes, image, imageAlt, imageCredit } = Astro.props;

const citySlug = Astro.url.pathname.replace('/cities/', '').replace(/\/$/, '');

// ── Resolve spoke references ──
const allPlaces = await getCollection('places', ({ data }) => !data.draft);
const allRoutes = await getCollection('routes', ({ data }) => !data.draft);
const allStories = await getCollection('stories', ({ data }) => !data.draft);
const allContext = await getCollection('context', ({ data }) => !data.draft);
const allGuides = await getCollection('guides', ({ data }) => !data.draft && data.citySlug === citySlug);

const placeMap = Object.fromEntries(allPlaces.map(p => [`places/${p.slug}`, p]));
const routeMap = Object.fromEntries(allRoutes.map(r => [`routes/${r.slug}`, r]));
const storyMap = Object.fromEntries(allStories.map(s => [`stories/${s.slug}`, s]));
const contextMap = Object.fromEntries(allContext.map(c => [`context/${c.slug}`, c]));

const spokeRefs = spokes || [];
const resolvedSpokes = spokeRefs.map(ref => {
    const entry = placeMap[ref] || routeMap[ref] || storyMap[ref] || contextMap[ref];
    if (!entry) return null;
    const type = ref.split('/')[0];
    return {
        type,
        slug: entry.slug,
        title: entry.data.title,
        description: entry.data.description,
        url: `/${ref}`,
    };
}).filter(Boolean);

const placeSpokes = resolvedSpokes.filter(s => s.type === 'places');
const routeSpokes = resolvedSpokes.filter(s => s.type === 'routes');
const storySpokes = resolvedSpokes.filter(s => s.type === 'stories');
const contextSpokes = resolvedSpokes.filter(s => s.type === 'context');

// ── Resolve destination guides for this city ──
const guideSpokes = allGuides.map(g => ({
    type: g.data.guideType,
    slug: g.slug,
    title: g.data.title,
    description: g.data.description,
    url: `/cities/${citySlug}/${g.slug}`,
}));

// ── Sibling cities ──
const allCities = await getCollection('cities', ({ data }) => !data.draft);
const siblingCities = allCities
    .filter(c => c.slug !== citySlug)
    .map(c => ({ slug: c.slug, title: c.data.title, description: c.data.description }));

// ── Stats ──
const totalArticles = resolvedSpokes.length + guideSpokes.length;
const heroStats = [
    { label: `${totalArticles} articles` },
    { label: `${placeSpokes.length} places` },
    { label: `${routeSpokes.length} routes` },
];
if (guideSpokes.length > 0) {
    heroStats.push({ label: `${guideSpokes.length} guides` });
}
if (faithTraditions && faithTraditions.length > 0) {
    heroStats.push({ label: faithTraditions.slice(0, 3).join(', ') });
}
---

<BaseLayout 
    title={title} 
    description={description}
    breadcrumbs={[
        { name: 'Home', url: '/' },
        { name: 'Cities', url: '/cities' },
        { name: title, url: Astro.url.pathname }
    ]}
>

<!-- HERO (shared component) -->
<HubHero
    image={image}
    imageAlt={imageAlt}
    badge={country || region || 'Sacred City'}
    title={title}
    tagline={tagline}
    description={description}
    stats={heroStats}
/>

<!-- MOBILE TOC -->
<SpokeMobileToc />

<!-- MAIN CONTENT -->
<article class="city-page">
    <div class="spoke-layout container">
        <div class="spoke-main">

            <!-- EDITORIAL PROSE -->
            <section class="city-content">
                <slot />
            </section>

            <!-- PRACTICAL GUIDES (destination silo spokes) -->
            {guideSpokes.length > 0 && (
                <section class="city-spokes-section">
                    <h2 class="city-spokes-heading">Practical Guides</h2>
                    <div class="city-spokes-grid">
                        {guideSpokes.map(spoke => (
                            <SpokeCard
                                href={spoke.url}
                                type={spoke.type}
                                title={spoke.title}
                                description={spoke.description}
                            />
                        ))}
                    </div>
                </section>
            )}

            <!-- SPOKE CARDS BY TYPE (shared SpokeCard component) -->
            {placeSpokes.length > 0 && (
                <section class="city-spokes-section">
                    <h2 class="city-spokes-heading">Sacred Places</h2>
                    <div class="city-spokes-grid">
                        {placeSpokes.map(spoke => (
                            <SpokeCard
                                href={spoke.url}
                                type={spoke.type}
                                title={spoke.title}
                                description={spoke.description}
                            />
                        ))}
                    </div>
                </section>
            )}

            {routeSpokes.length > 0 && (
                <section class="city-spokes-section">
                    <h2 class="city-spokes-heading">Pilgrimage Routes</h2>
                    <div class="city-spokes-grid">
                        {routeSpokes.map(spoke => (
                            <SpokeCard
                                href={spoke.url}
                                type={spoke.type}
                                title={spoke.title}
                                description={spoke.description}
                            />
                        ))}
                    </div>
                </section>
            )}

            {(storySpokes.length > 0 || contextSpokes.length > 0) && (
                <section class="city-spokes-section">
                    <h2 class="city-spokes-heading">Stories &amp; Context</h2>
                    <div class="city-spokes-grid">
                        {[...storySpokes, ...contextSpokes].map(spoke => (
                            <SpokeCard
                                href={spoke.url}
                                type={spoke.type}
                                title={spoke.title}
                                description={spoke.description}
                            />
                        ))}
                    </div>
                </section>
            )}

        </div>
        <SpokeSidebar />
    </div>
</article>

<!-- SIBLING CITIES (shared component) -->
<SiblingNav
    label="Explore other sacred cities"
    basePath="/cities"
    items={siblingCities}
/>

</BaseLayout>

<style>
    .city-spokes-section { margin: 2.5rem 0; }
    .city-spokes-heading {
        font-family: 'Playfair Display Variable', serif;
        font-size: 1.35rem;
        color: #1c1917;
        margin: 0 0 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid #6D28D9;
        display: inline-block;
    }
    .city-spokes-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 1rem;
    }
</style>
